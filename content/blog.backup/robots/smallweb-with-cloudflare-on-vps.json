{
  "slug": "robots/smallweb-with-cloudflare-on-vps",
  "title": "Development routes",
  "date": "2024-12-08T20:13:29.000Z",
  "type": "robot",
  "html": "<p>I'll create a detailed walkthrough of how we got this stack working:</p>\n<h2 id=\"setting-up-smallweb-with-cloudflare-tunnel-and-caddy\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#setting-up-smallweb-with-cloudflare-tunnel-and-caddy\"><span class=\"icon icon-link\"></span></a>Setting up Smallweb with Cloudflare Tunnel and Caddy</h2>\n<h3 id=\"stack-overview\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#stack-overview\"><span class=\"icon icon-link\"></span></a>Stack Overview</h3>\n<ul>\n<li>Smallweb serving on port 7777</li>\n<li>Datasette running on port 8002 (as an example of another service)</li>\n<li>Caddy as the local reverse proxy on port 80</li>\n<li>Cloudflare Tunnel routing all <code>*.tools.ejfox.com</code> traffic to the VPS</li>\n<li>SSL handled by Cloudflare</li>\n</ul>\n<h3 id=\"configuration-steps\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#configuration-steps\"><span class=\"icon icon-link\"></span></a>Configuration Steps</h3>\n<h4 id=\"1-initial-setup\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#1-initial-setup\"><span class=\"icon icon-link\"></span></a>1. Initial Setup</h4>\n<ul>\n<li>Created <code>~/smallweb</code> directory</li>\n<li>Created <code>~/smallweb/.smallweb/config.json</code> with:</li>\n</ul>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#24292e;color:#e1e4e8\" tabindex=\"0\" data-language=\"json\" data-theme=\"github-dark\"><code data-language=\"json\" data-theme=\"github-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#E1E4E8\">{</span></span>\n<span data-line=\"\"><span style=\"color:#79B8FF\">  \"domain\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"tools.ejfox.com\"</span></span>\n<span data-line=\"\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></figure>\n<ul>\n<li>Smallweb process running as debian user: <code>/home/debian/.local/bin/smallweb up --cron</code></li>\n</ul>\n<h4 id=\"2-cloudflare-tunnel-configuration\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#2-cloudflare-tunnel-configuration\"><span class=\"icon icon-link\"></span></a>2. Cloudflare Tunnel Configuration</h4>\n<ul>\n<li>Created tunnel named <code>ejfox.com</code> through Cloudflare dashboard</li>\n<li>Set up public hostname:\n<ul>\n<li>Subdomain: <code>*.tools</code></li>\n<li>Domain: <code>ejfox.com</code></li>\n<li>Path: (empty)</li>\n<li>Service: <code>http://localhost:80</code> (pointing to Caddy)</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"3-caddy-configuration\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#3-caddy-configuration\"><span class=\"icon icon-link\"></span></a>3. Caddy Configuration</h4>\n<p>Created <code>/etc/caddy/Caddyfile</code>:</p>\n<pre><code>{\n    # Globally disable automatic HTTPS since Cloudflare handles it\n    auto_https off\n}\n\n# Development routes\n:80, localhost:80, *.localhost:80 {\n    reverse_proxy localhost:7777\n}\n\n# Production routes for tools subdomains\nhttp://*.tools.ejfox.com {\n    @datasette host datasette.tools.ejfox.com\n    handle @datasette {\n        reverse_proxy localhost:8002\n    }\n\n    handle {\n        reverse_proxy localhost:7777\n    }\n}\n</code></pre>\n<h4 id=\"4-running-the-services\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#4-running-the-services\"><span class=\"icon icon-link\"></span></a>4. Running the Services</h4>\n<ol>\n<li>Started smallweb:</li>\n</ol>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#24292e;color:#e1e4e8\" tabindex=\"0\" data-language=\"bash\" data-theme=\"github-dark\"><code data-language=\"bash\" data-theme=\"github-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#B392F0\">/home/debian/.local/bin/smallweb</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#79B8FF\"> --cron</span></span></code></pre></figure>\n<ol start=\"2\">\n<li>Started Caddy:</li>\n</ol>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#24292e;color:#e1e4e8\" tabindex=\"0\" data-language=\"bash\" data-theme=\"github-dark\"><code data-language=\"bash\" data-theme=\"github-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#B392F0\">sudo</span><span style=\"color:#9ECBFF\"> systemctl</span><span style=\"color:#9ECBFF\"> restart</span><span style=\"color:#9ECBFF\"> caddy</span></span></code></pre></figure>\n<ol start=\"3\">\n<li>Started Cloudflare Tunnel:</li>\n</ol>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#24292e;color:#e1e4e8\" tabindex=\"0\" data-language=\"bash\" data-theme=\"github-dark\"><code data-language=\"bash\" data-theme=\"github-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#B392F0\">sudo</span><span style=\"color:#9ECBFF\"> cloudflared</span><span style=\"color:#79B8FF\"> --no-autoupdate</span><span style=\"color:#9ECBFF\"> tunnel</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#79B8FF\"> --token</span><span style=\"color:#F97583\"> &#x3C;</span><span style=\"color:#9ECBFF\">tunnel-toke</span><span style=\"color:#E1E4E8\">n</span><span style=\"color:#F97583\">></span></span></code></pre></figure>\n<h3 id=\"key-learnings--notes\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#key-learnings--notes\"><span class=\"icon icon-link\"></span></a>Key Learnings &#x26; Notes</h3>\n<ol>\n<li>Smallweb binds to both IPv4 and IPv6 (<code>:::7777</code>)</li>\n<li>Using Caddy as the central router allows for easy addition of new services</li>\n<li>The stack allows for dynamic subdomain routing without modifying Cloudflare config</li>\n<li>Running as the debian user worked fine (didn't need dedicated smallweb user)</li>\n<li>Cloudflare Tunnel configuration needs to point to Caddy (port 80) rather than directly to smallweb</li>\n</ol>\n<h3 id=\"verification\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#verification\"><span class=\"icon icon-link\"></span></a>Verification</h3>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#24292e;color:#e1e4e8\" tabindex=\"0\" data-language=\"bash\" data-theme=\"github-dark\"><code data-language=\"bash\" data-theme=\"github-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#6A737D\"># Check services</span></span>\n<span data-line=\"\"><span style=\"color:#B392F0\">sudo</span><span style=\"color:#9ECBFF\"> netstat</span><span style=\"color:#79B8FF\"> -tlpn</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -E</span><span style=\"color:#9ECBFF\"> ':(80|8002|7777)'</span></span>\n<span data-line=\"\"><span style=\"color:#B392F0\">tcp</span><span style=\"color:#79B8FF\">        0</span><span style=\"color:#79B8FF\">      0</span><span style=\"color:#9ECBFF\"> 127.0.0.1:8002</span><span style=\"color:#9ECBFF\">          0.0.0.0:</span><span style=\"color:#79B8FF\">*</span><span style=\"color:#9ECBFF\">               LISTEN</span><span style=\"color:#9ECBFF\">      11484/python3</span></span>\n<span data-line=\"\"><span style=\"color:#B392F0\">tcp6</span><span style=\"color:#79B8FF\">       0</span><span style=\"color:#79B8FF\">      0</span><span style=\"color:#9ECBFF\"> :::7777</span><span style=\"color:#9ECBFF\">                 :::</span><span style=\"color:#79B8FF\">*</span><span style=\"color:#9ECBFF\">                    LISTEN</span><span style=\"color:#9ECBFF\">      9009/smallweb</span></span>\n<span data-line=\"\"><span style=\"color:#B392F0\">tcp6</span><span style=\"color:#79B8FF\">       0</span><span style=\"color:#79B8FF\">      0</span><span style=\"color:#9ECBFF\"> :::80</span><span style=\"color:#9ECBFF\">                   :::</span><span style=\"color:#79B8FF\">*</span><span style=\"color:#9ECBFF\">                    LISTEN</span><span style=\"color:#9ECBFF\">      12890/caddy</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#6A737D\"># Verify smallweb</span></span>\n<span data-line=\"\"><span style=\"color:#B392F0\">smallweb</span><span style=\"color:#9ECBFF\"> doctor</span></span>\n<span data-line=\"\"><span style=\"color:#B392F0\">smallweb</span><span style=\"color:#9ECBFF\"> list</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#6A737D\"># Test endpoints</span></span>\n<span data-line=\"\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> https://example.tools.ejfox.com</span><span style=\"color:#6A737D\">  # Returns \"Smallweb is running\"</span></span>\n<span data-line=\"\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> https://datasette.tools.ejfox.com</span><span style=\"color:#6A737D\">  # Returns Datasette interface</span></span></code></pre></figure>\n<h3 id=\"final-result\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#final-result\"><span class=\"icon icon-link\"></span></a>Final Result</h3>\n<ul>\n<li>All traffic encrypted via Cloudflare</li>\n<li>Dynamic subdomain routing working</li>\n<li>Multiple services running behind single domain</li>\n<li>Easy to add new services or smallweb sites</li>\n</ul>\n<p>Let me know if you'd like me to expand on any part of this documentation!</p>",
  "modified": "2024-12-08T22:46:33.000Z",
  "description": "",
  "dek": "",
  "url": "",
  "tags": [],
  "hidden": false,
  "draft": false,
  "wordCount": 393,
  "readingTime": 2,
  "imageCount": 0,
  "linkCount": 0,
  "share": true
}